# 企业微信智能机器人 - 快速配置指南

## 🚀 5分钟快速上手

### 步骤 1: 创建智能机器人

1. 登录 [企业微信管理后台](https://work.weixin.qq.com/)
2. 进入「应用管理」→「智能机器人」
3. 点击「创建智能机器人」
4. 填写机器人名称和描述
5. 开启「API 模式」

### 步骤 2: 获取配置信息

在智能机器人的「接收消息」配置页面，你会看到：

```
Token: your-token-here
EncodingAESKey: your-aes-key-here
```

**注意：** 智能机器人使用被动回复模式，**不需要** Secret 和 aibot_id！

### 步骤 3: 配置 config.json

复制 `config.json.template` 为 `config.json`，填入以下信息：

```json
{
  "channel_type": "wechatcom_aibot",

  "wechatcom_corp_id": "ww1234567890abcdef",
  "wechatcom_aibot_token": "your-token-here",
  "wechatcom_aibot_aes_key": "your-aes-key-here",
  "wechatcom_aibot_port": 9899,

  "model": "dify",
  "dify_api_key": "your-dify-api-key"
}
```

### 步骤 4: 配置回调 URL

在企业微信智能机器人管理后台，配置回调 URL：

```
http://你的服务器IP:9899/wxaibot/
```

**本地测试：** 可以使用 ngrok 或 frp 进行内网穿透

```bash
# 使用 ngrok
ngrok http 9899

# 然后使用 ngrok 提供的 URL
https://xxxx.ngrok.io/wxaibot/
```

### 步骤 5: 启动服务

```bash
python app.py
```

看到以下日志表示启动成功：

```
[wechatcom_aibot] Initializing: corp_id=ww..., aibot_id=AIBOTID_...
[wechatcom_aibot] Starting web server on port 9899
```

### 步骤 6: 验证 URL

在企业微信管理后台点击「保存」，系统会验证 URL 有效性。

✅ 验证成功：显示「验证成功」
❌ 验证失败：检查配置和日志

### 步骤 7: 测试对话

1. 在企业微信中找到你的智能机器人
2. 发送消息：`你好`
3. 机器人应该会回复

## 📋 完整配置示例

### 最小配置（仅文本对话）

```json
{
  "channel_type": "wechatcom_aibot",
  "wechatcom_corp_id": "ww1234567890abcdef",
  "wechatcom_aibot_token": "your-token",
  "wechatcom_aibot_aes_key": "your-aes-key",
  "model": "dify",
  "dify_api_key": "your-dify-api-key"
}
```

### 完整配置（包含语音识别）

**注意：** 智能机器人 API 不支持语音消息，如需语音功能请使用 wechatcom_app 通道

```json
{
  "channel_type": "wechatcom_aibot",

  "wechatcom_corp_id": "ww1234567890abcdef",
  "wechatcom_aibot_token": "your-token",
  "wechatcom_aibot_aes_key": "your-aes-key",
  "wechatcom_aibot_port": 9899,
  "wechatcom_aibot_enable_stream": true,
  
  "model": "dify",
  "dify_api_base": "https://api.dify.ai/v1",
  "dify_api_key": "your-dify-api-key",
  "dify_app_type": "chatbot",
  
  "speech_recognition": true,
  "voice_to_text": "funasr",
  "funasr_url": "ws://localhost:10095",
  "funasr_model": "sensevoice",
  "funasr_enable_itn": true,
  
  "single_chat_prefix": [],
  "group_chat_prefix": ["@bot"],
  "group_name_white_list": ["ALL_GROUP"],
  "conversation_max_tokens": 2500
}
```

## 🔧 配置参数详解

### 必填参数

| 参数 | 说明 | 获取方式 |
|------|------|----------|
| `wechatcom_corp_id` | 企业 ID | 企业微信管理后台 → 我的企业 → 企业信息 |
| `wechatcom_aibot_token` | 回调 Token | 智能机器人 → 接收消息配置 → Token |
| `wechatcom_aibot_aes_key` | 回调 AES Key | 智能机器人 → 接收消息配置 → EncodingAESKey |

### 可选参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `wechatcom_aibot_port` | `9899` | 服务端口 |
| `wechatcom_aibot_enable_stream` | `true` | 是否启用流式消息 |

## ⚠️ 常见问题

### Q1: URL 验证失败

**错误信息：** "验证失败，请检查 URL 配置"

**解决方法：**
1. 检查服务是否启动：`ps aux | grep python`
2. 检查端口是否开放：`netstat -tuln | grep 9899`
3. 检查防火墙：`sudo ufw status`
4. 查看日志：`tail -f logs/log-*.log`

### Q2: 收不到消息

**可能原因：**
- 回调 URL 配置错误
- Token 或 AES Key 不匹配
- 服务未正常运行

**解决方法：**
1. 检查回调 URL 是否正确
2. 重新验证 URL
3. 查看日志中的错误信息

### Q3: 图片无法显示

**错误信息：** "Failed to decrypt image"

**解决方法：**
```bash
pip install pycryptodome
```

### Q4: 回复超时

**错误信息：** "机器人未响应"

**原因：** 企业微信要求 5 秒内响应

**解决方法：**
- 优化 LLM 响应速度
- 使用流式消息
- 检查网络连接

## 🌐 云服务器部署

### 1. 开放端口

```bash
# Ubuntu/Debian
sudo ufw allow 9899

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=9899/tcp
sudo firewall-cmd --reload
```

### 2. 使用 Nginx 反向代理（推荐）

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location /wxaibot/ {
        proxy_pass http://127.0.0.1:9899/wxaibot/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. 配置 HTTPS（推荐）

```bash
# 使用 Let's Encrypt
sudo certbot --nginx -d your-domain.com
```

### 4. 使用 systemd 管理服务

创建 `/etc/systemd/system/sga-cow.service`：

```ini
[Unit]
Description=SGA-CoW Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/sga-cow
ExecStart=/usr/bin/python3 /path/to/sga-cow/app.py
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable sga-cow
sudo systemctl start sga-cow
sudo systemctl status sga-cow
```

## 📊 监控和日志

### 查看日志

```bash
# 实时查看日志
tail -f logs/log-*.log

# 查看错误日志
grep ERROR logs/log-*.log

# 查看智能机器人相关日志
grep wechatcom_aibot logs/log-*.log
```

### 日志级别

在 `config.json` 中设置：

```json
{
  "debug": true
}
```

## 🎯 下一步

- ✅ 基础文本对话已可用
- ⏳ 配置流式消息回复
- ⏳ 添加模板卡片支持
- ⏳ 集成语音识别

## 📚 相关文档

- [完整 README](README.md)
- [企业微信智能机器人 API 文档](../../rules/企业微信智能机器人.md)
- [企业微信开发者文档](https://developer.work.weixin.qq.com/)

