# 企业微信智能机器人 Channel

## 📖 概述

企业微信智能机器人 Channel 是专门为企业微信智能机器人 API 设计的通道实现，支持被动回复、流式消息、模板卡片等高级功能。

### 与 wechatcom_app 的区别

| 特性 | wechatcom_app | wechatcom_aibot |
|------|---------------|-----------------|
| **API 类型** | 企业微信应用 API | 企业微信智能机器人 API |
| **消息模式** | 主动发送 | 被动回复 |
| **需要参数** | agent_id | aibot_id |
| **流式消息** | ❌ 不支持 | ✅ 支持 |
| **模板卡片** | ❌ 不支持 | ✅ 支持 |
| **图文混排** | ❌ 不支持 | ✅ 支持 |
| **响应时间** | 无限制 | 5秒内响应 |

## 🚀 快速开始

### 1. 创建企业微信智能机器人

1. 登录企业微信管理后台
2. 进入「应用管理」→「智能机器人」
3. 创建新的智能机器人
4. 开启 API 模式
5. 配置回调 URL 和加密信息

### 2. 配置 config.json

```json
{
  "channel_type": "wechatcom_aibot",

  "wechatcom_corp_id": "你的企业ID",
  "wechatcom_aibot_token": "回调Token",
  "wechatcom_aibot_aes_key": "回调EncodingAESKey",
  "wechatcom_aibot_port": 9899,
  "wechatcom_aibot_enable_stream": true
}
```

### 3. 配置回调 URL

在企业微信智能机器人管理后台配置：

```
回调 URL: http://你的服务器IP:9899/wxaibot/
```

**注意：** 
- 如果使用云服务器，需要开放 9899 端口
- 建议使用 HTTPS（需要配置 SSL 证书）
- 企业微信会验证 URL 有效性

### 4. 启动服务

```bash
python app.py
```

## 📋 配置参数说明

### 必填参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `channel_type` | 通道类型 | `"wechatcom_aibot"` |
| `wechatcom_corp_id` | 企业微信公司的 corpID | `"ww1234567890abcdef"` |
| `wechatcom_aibot_token` | 回调 Token | `"your-token"` |
| `wechatcom_aibot_aes_key` | 回调 EncodingAESKey | `"your-aes-key"` |

### 可选参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `wechatcom_aibot_port` | `9899` | 服务端口 |
| `wechatcom_aibot_enable_stream` | `true` | 是否启用流式消息回复 |

## 🎯 支持的功能

### 1. 消息类型

#### ✅ 接收消息

- **文本消息**：用户@机器人或单聊发送的文本
- **图片消息**：单聊中发送的图片（自动解密）
- **图文混排消息**：文本+图片的混合消息
- **流式消息刷新**：用于流式回复的刷新事件

#### ✅ 回复消息

- **文本消息**：普通文本回复
- **流式消息**：支持 Markdown 格式、思考过程展示
- **模板卡片**：文本通知、图文展示、按钮交互等（待实现）

### 2. 流式消息回复

流式消息可以实现类似 ChatGPT 的打字效果：

```json
{
  "msgtype": "stream",
  "stream": {
    "id": "STREAMID",
    "finish": false,
    "content": "**广州**今日天气：29度，大部分多云"
  }
}
```

**特点：**
- 支持 Markdown 格式
- 支持思考过程标签 `<think></think>`
- 支持图文混排（最多 10 张图片）
- 最长 20480 字节

### 3. 图片解密

企业微信智能机器人的图片是加密的，使用 AES-256-CBC 加密：

- **加密方式**：AES-256-CBC
- **IV 初始向量**：取 AESKey 前 16 字节
- **自动解密**：Channel 会自动解密图片

**依赖：** 需要安装 `pycryptodome`

```bash
pip install pycryptodome
```

### 4. 被动回复模式

智能机器人使用被动回复模式，与微信公众号类似：

- 企业微信会在 **5 秒内** 重试 3 次
- 必须在 5 秒内返回回复
- 使用缓存机制处理长时间任务

## 🔧 高级配置

### 1. 启用流式消息

在 `config.json` 中设置：

```json
{
  "wechatcom_aibot_enable_stream": true
}
```

### 2. 自定义端口

```json
{
  "wechatcom_aibot_port": 8899
}
```

### 3. 配置语音识别

智能机器人暂不支持语音消息，如需语音功能，请使用 `wechatcom_app` 通道。

## 📝 使用示例

### 示例 1：基础文本对话

**用户：** @机器人 你好

**机器人：** 你好！我是智能助手，有什么可以帮助你的吗？

### 示例 2：图文混排

**用户：** @机器人 这是今天的报告 [图片]

**机器人：** 我看到了你的报告图片，正在分析...

### 示例 3：流式消息（待实现）

**用户：** @机器人 介绍一下企业微信

**机器人：** （逐字显示）企业微信是腾讯推出的企业通讯与办公工具...

## ⚠️ 注意事项

### 1. 响应时间限制

- 企业微信会在 **5 秒内** 重试 3 次
- 如果 3 次都超时，会显示"机器人未响应"
- 建议使用异步处理或缓存机制

### 2. 图片加密

- 图片 URL 仅 **5 分钟** 内有效
- 图片是 **加密的**，需要解密才能使用
- 需要安装 `pycryptodome` 库

### 3. 流式消息限制

- 从用户发消息开始，最多等待 **6 分钟**
- 超过 6 分钟，企业微信会停止推送刷新事件
- 用户最多同时有 **3 条消息** 交互中

### 4. 端口配置

- 默认端口：9899
- 需要在防火墙中开放该端口
- 建议使用 Nginx 反向代理配置 HTTPS

## 🐛 常见问题

### Q1: URL 验证失败

**A:** 检查以下配置：
- `wechatcom_aibot_token` 是否正确
- `wechatcom_aibot_aes_key` 是否正确
- `wechatcom_corp_id` 是否正确
- 服务是否正常启动
- 端口是否开放

### Q2: 收不到消息

**A:** 检查：
- 回调 URL 是否配置正确
- 服务是否正常运行
- 查看日志中是否有错误信息

### Q3: 图片无法显示

**A:** 
- 确保已安装 `pycryptodome`
- 检查 `wechatcom_aibot_aes_key` 是否正确
- 图片 URL 是否在 5 分钟内

### Q4: 回复超时

**A:**
- 检查 LLM 响应速度
- 考虑使用流式消息
- 优化处理逻辑

## 📚 参考文档

- [企业微信智能机器人 API 文档](rules/企业微信智能机器人.md)
- [企业微信开发者中心](https://developer.work.weixin.qq.com/)

## 🔄 更新日志

### v1.0.0 (2025-10-28)

- ✅ 支持文本消息接收和回复
- ✅ 支持图片消息接收（自动解密）
- ✅ 支持图文混排消息
- ✅ 支持流式消息刷新（基础框架）
- ✅ 被动回复模式
- ⏳ 模板卡片支持（待实现）
- ⏳ 完整的流式消息回复（待实现）

## 📞 技术支持

如有问题，请查看：
1. 项目日志文件
2. 企业微信智能机器人管理后台的错误信息
3. 本项目的 Issues

