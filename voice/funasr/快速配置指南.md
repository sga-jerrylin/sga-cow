# FunASR 快速配置指南

## ⚠️ 重要提示

**必须在 `config.json` 中设置 `"voice_to_text": "funasr"` 才能使用 FunASR！**

如果不设置，系统会使用默认的 OpenAI Whisper 引擎。

## 🚀 快速开始

### 第一步：启动 FunASR 服务

#### 使用 SenseVoice（多语言 + 情感识别）

```bash
docker run -d \
  --name funasr-sensevoice \
  -p 10095:10095 \
  registry.cn-hangzhou.aliyuncs.com/funasr_repo/funasr:funasr-runtime-sdk-online-cpu-0.1.10
```

#### 使用 Paraformer（高精度中文）

```bash
docker run -d \
  --name funasr-paraformer \
  -p 10096:10096 \
  registry.cn-hangzhou.aliyuncs.com/funasr_repo/funasr:funasr-runtime-sdk-online-cpu-0.1.10
```

### 第二步：修改 config.json

#### 配置 SenseVoice

```json
{
  "voice_to_text": "funasr",
  "speech_recognition": true,
  "funasr_url": "ws://localhost:10095",
  "funasr_model": "sensevoice",
  "funasr_enable_itn": true
}
```

#### 配置 Paraformer

```json
{
  "voice_to_text": "funasr",
  "speech_recognition": true,
  "funasr_url": "ws://localhost:10096",
  "funasr_model": "paraformer",
  "funasr_enable_itn": true,
  "funasr_hotwords": "企业微信 Dify 人工智能"
}
```

### 第三步：安装依赖

```bash
pip install websockets
```

### 第四步：重启服务

```bash
python app.py
```

## 📋 配置参数说明

| 参数 | 是否必填 | 说明 | SenseVoice | Paraformer |
|------|---------|------|------------|------------|
| `voice_to_text` | ✅ **必填** | 必须设置为 `"funasr"` | ✅ | ✅ |
| `speech_recognition` | ✅ **必填** | 是否开启语音识别 | `true` | `true` |
| `funasr_url` | ⚙️ 可选 | WebSocket 地址 | `ws://localhost:10095` | `ws://localhost:10096` |
| `funasr_model` | ⚙️ 可选 | 模型名称 | `sensevoice` | `paraformer` |
| `funasr_enable_itn` | ⚙️ 可选 | 数字转换 | ✅ | ✅ |
| `funasr_hotwords` | ⚙️ 可选 | 热词（提高识别率） | ❌ | ✅ |
| `funasr_audio_fs` | ⚙️ 可选 | 采样率 | `16000` | `16000` |

## 🎯 模型选择建议

### 选择 SenseVoice 的场景：
- ✅ 需要识别多种语言（中英日韩粤）
- ✅ 需要情感分析
- ✅ 实时对话场景
- ✅ 不确定用户会说什么语言

### 选择 Paraformer 的场景：
- ✅ 纯中文场景
- ✅ 需要高精度识别（会议记录、文件转写）
- ✅ 需要自动标点符号
- ✅ 有专业术语需要识别（可使用热词）

## 🔧 常见问题

### Q1: 为什么配置了 FunASR 但还是用的 OpenAI？

**答：必须在 `config.json` 中设置 `"voice_to_text": "funasr"`！**

如果不设置这个参数，系统会使用默认的 OpenAI Whisper 引擎。

```json
{
  "voice_to_text": "funasr",  // ← 这个必须填！
  "speech_recognition": true,
  "funasr_url": "ws://localhost:10095"
}
```

### Q2: 如何测试 FunASR 是否正常运行？

```bash
# 测试 SenseVoice
python voice/funasr/funasr_api.py test.wav sensevoice

# 测试 Paraformer
python voice/funasr/funasr_api.py test.wav paraformer
```

### Q3: 连接失败怎么办？

检查服务是否运行：
```bash
docker ps | grep funasr
```

查看日志：
```bash
docker logs funasr-sensevoice
# 或
docker logs funasr-paraformer
```

### Q3: 如何使用热词？

热词仅 Paraformer 支持，在 config.json 中配置：

```json
{
  "funasr_hotwords": "人工智能 深度学习 神经网络 企业微信 Dify"
}
```

**注意：**
- 热词之间用空格分隔
- 建议 10-20 个热词
- 热词应该是完整的词语

### Q4: ITN 是什么？

ITN（逆文本归一化）将文字数字转换为阿拉伯数字：

- ✅ 启用 ITN：`"funasr_enable_itn": true`
  - "一千二百" → "1200"
  - "二零二三年" → "2023年"
  
- ❌ 禁用 ITN：`"funasr_enable_itn": false`
  - 保持原始文字形式

## 📊 性能对比

| 特性 | SenseVoice | Paraformer |
|------|------------|------------|
| 语言支持 | 中英日韩粤 | 仅中文 |
| 识别准确率 | 较高 | 极高（CER 1.95%） |
| 标点符号 | ✅ | ✅ |
| 情感识别 | ✅ | ❌ |
| 热词支持 | ❌ | ✅ |
| 适用场景 | 实时对话 | 会议转写 |

## 🔗 相关文档

- 详细文档：`voice/funasr/README.md`
- SenseVoice API 规则：`rules/sensevoice_api_rules.md`
- Paraformer API 规则：`rules/paraformer_api_rules.md`
- FunASR 官方：https://github.com/alibaba/FunASR

## 💡 完整配置示例

### 示例 1：企业微信 + SenseVoice（多语言场景）

```json
{
  "channel_type": "wechatcom_app",
  "model": "dify",
  "voice_to_text": "funasr",
  "speech_recognition": true,
  "group_speech_recognition": true,
  
  "funasr_url": "ws://localhost:10095",
  "funasr_model": "sensevoice",
  "funasr_enable_itn": true,
  "funasr_audio_fs": 16000,
  
  "dify_api_key": "your-dify-api-key",
  "dify_api_base": "https://api.dify.ai/v1",
  
  "wechatcom_corp_id": "your-corp-id",
  "wechatcomapp_secret": "your-secret",
  "wechatcomapp_agent_id": "your-agent-id"
}
```

### 示例 2：企业微信 + Paraformer（高精度中文）

```json
{
  "channel_type": "wechatcom_app",
  "model": "dify",
  "voice_to_text": "funasr",
  "speech_recognition": true,
  "group_speech_recognition": true,
  
  "funasr_url": "ws://localhost:10096",
  "funasr_model": "paraformer",
  "funasr_enable_itn": true,
  "funasr_hotwords": "企业微信 Dify 人工智能 深度学习",
  "funasr_audio_fs": 16000,
  
  "dify_api_key": "your-dify-api-key",
  "dify_api_base": "https://api.dify.ai/v1",
  
  "wechatcom_corp_id": "your-corp-id",
  "wechatcomapp_secret": "your-secret",
  "wechatcomapp_agent_id": "your-agent-id"
}
```

